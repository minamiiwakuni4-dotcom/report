<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆæ¥­å ±å‘Š V3 - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #4a90e2; --success: #2ecc71; --bg: #f4f7f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; }
        
        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ */
        .card-done { background-color: #f3f4f6; opacity: 0.6; border-left: 8px solid #10b981; }
        .card-active { border-left: 8px solid #3b82f6; background-color: white; }
        
        /* V1ç§»æ¤ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .choice-btn { flex: 1; min-width: 70px; padding: 10px 4px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-size: 0.8rem; font-weight: bold; transition: 0.2s; }
        .choice-btn.active { border-color: #3b82f6; background: #eef6ff; color: #3b82f6; }
        .eval-good.active { background: #2ecc71; color: white; border: none; }
        .eval-normal.active { background: #f1c40f; color: white; border: none; }
        .eval-effort.active { background: #e74c3c; color: white; border: none; }
        
        .preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .preview-item { position: relative; aspect-ratio: 3/4; background: #ddd; border-radius: 4px; overflow: hidden; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .del-btn { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; }
    </style>
</head>
<body class="pb-20">

    <div id="dashboardView">
        <header class="bg-white shadow-sm p-4 sticky top-0 z-10 text-center">
            <h1 class="text-lg font-bold text-slate-700">æˆæ¥­å ±å‘Šã‚·ã‚¹ãƒ†ãƒ  V3</h1>
            <div class="flex gap-2 mt-3">
                <input type="text" id="studentSearch" oninput="searchStudent()" placeholder="ç”Ÿå¾’åã§æ¤œç´¢..." class="flex-1 border rounded-lg px-3 py-2 text-sm shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
                <button onclick="loadData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md">ğŸ”„ æ›´æ–°</button>
            </div>
        </header>

        <div id="settings" class="m-4 p-4 bg-orange-50 border border-orange-200 rounded-lg text-sm">
            <span class="font-bold text-orange-800">ğŸ”‘ APIã‚­ãƒ¼è¨­å®š</span>
            <input type="password" id="apiKeyInput" class="w-full mt-2 p-2 border rounded" placeholder="AIza...">
            <button onclick="saveKey()" class="w-full mt-2 bg-slate-500 text-white p-2 rounded font-bold">ã‚­ãƒ¼ã‚’ä¿å­˜</button>
        </div>

        <main id="cardContainer" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="text-center py-10 text-gray-500">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </main>
    </div>

    <div id="reportView" class="hidden fixed inset-0 bg-white z-20 overflow-y-auto">
        <header class="bg-blue-600 text-white p-4 sticky top-0 flex justify-between items-center shadow-md">
            <button onclick="backToDashboard()" class="font-bold bg-blue-700 px-3 py-1 rounded">ï¼œ æˆ»ã‚‹</button>
            <div class="text-center leading-tight">
                <div id="viewStudentName" class="text-lg font-bold"></div>
                <div id="viewSubInfo" class="text-xs opacity-90"></div>
            </div>
            <div class="w-12"></div>
        </header>
        
        <div class="p-4 space-y-6">
            <div>
                <span class="text-sm font-bold text-slate-600 mb-2 block">æ•™ç§‘é¸æŠ</span>
                <div class="flex gap-2" id="subjectGroup">
                    <button class="choice-btn active" onclick="changeSubject('è‹±èª', this)">è‹±èª</button>
                    <button class="choice-btn" onclick="changeSubject('æ•°å­¦', this)">æ•°å­¦</button>
                    <button class="choice-btn" onclick="changeSubject('å›½èª', this)">å›½èª</button>
                    <button class="choice-btn" onclick="changeSubject('ç†ç§‘', this)">ç†ç§‘</button>
                    <button class="choice-btn" onclick="changeSubject('ç¤¾ä¼š', this)">ç¤¾ä¼š</button>
                </div>
            </div>

            <div id="evaluationContainer" class="bg-slate-50 p-4 rounded-xl border border-slate-200"></div>

            <div class="bg-white border-2 border-dashed border-blue-300 rounded-xl p-6 text-center shadow-inner">
                <button onclick="document.getElementById('cameraInput').click()" class="bg-blue-500 text-white w-full py-4 rounded-xl font-bold shadow-lg active:scale-95 transition">ğŸ“· ãƒãƒ¼ãƒˆã‚’æ’®å½± (é€£å†™å¯)</button>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" multiple style="display:none" onchange="handleFiles(this.files)">
                <div class="preview-grid" id="previewGrid"></div>
            </div>

            <div id="aiSection" class="space-y-4">
                <div class="flex justify-between items-center px-1">
                    <span class="text-sm font-bold text-slate-600">AIä½œæˆã®å ±å‘Šæ–‡</span>
                    <button onclick="copyText()" class="text-xs bg-slate-400 text-white px-3 py-1 rounded font-bold">ã‚³ãƒ”ãƒ¼</button>
                </div>
                <div id="loading" class="hidden text-center text-blue-600 font-bold animate-pulse py-2">ğŸš€ AIãŒåˆ†æä¸­...</div>
                <textarea id="output" class="w-full h-48 p-4 border-2 border-blue-50 rounded-2xl text-sm focus:border-blue-400 outline-none shadow-sm" placeholder="ã“ã“ã«æ–‡ç« ãŒç”Ÿæˆã•ã‚Œã¾ã™"></textarea>
                
                <div class="px-1 text-center">
                    <span class="text-xs text-slate-400 block mb-2">é€£çµæ¸ˆã¿ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                    <img id="mergedImagePreview" class="hidden w-full max-w-sm mx-auto rounded-lg border-2 border-white shadow-md">
                </div>
            </div>
        </div>

        <div class="p-4 bg-white/90 backdrop-blur-md border-t sticky bottom-0 flex gap-4 z-30">
            <button id="generateBtn" onclick="runAI()" class="flex-1 bg-emerald-500 text-white py-4 rounded-2xl text-lg font-bold shadow-xl active:bg-emerald-600 transition">AIå ±å‘Šä½œæˆ</button>
            <button id="saveBtn" onclick="saveToSheet()" class="hidden flex-1 bg-blue-600 text-white py-4 rounded-2xl text-lg font-bold shadow-xl active:bg-blue-700 transition">ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¦å®Œäº†</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw5nrIhB1VGihn7vomC6zKG7ViBXxRJQ_0aSrTX_3HdU4u9D-0CuHinX8XhA5tu3KqSsw/exec";
        let scheduleData = [];
        let doneList = JSON.parse(localStorage.getItem('doneListV3') || "[]");
        let photoList = [];
        let selectedSubject = 'è‹±èª';
        let currentEvals = {};
        const subjectConfig = {
            'è‹±èª': ['é›†ä¸­åº¦', 'ç†è§£åº¦', 'æ–‡æ³•ç†è§£', 'èªå½™åŠ›'],
            'æ•°å­¦': ['é›†ä¸­åº¦', 'ç†è§£åº¦', 'è¨ˆç®—åŠ›', 'è¨˜è¿°åŠ›'],
            'ç†ç§‘': ['é›†ä¸­åº¦', 'ç†è§£åº¦', 'ç”¨èªå…¬å¼æš—è¨˜', 'è¨˜è¿°åŠ›'],
            'ç¤¾ä¼š': ['é›†ä¸­åº¦', 'ç†è§£åº¦', 'ç”¨èªæš—è¨˜', 'è¨˜è¿°åŠ›'],
            'å›½èª': ['é›†ä¸­åº¦', 'ç†è§£åº¦', 'å†…å®¹æŠŠæ¡', 'è¨˜è¿°åŠ›']
        };

        // --- åˆæœŸåŒ– (URLã‹ã‚‰ã®ã‚­ãƒ¼è‡ªå‹•è¨­å®šæ©Ÿèƒ½ä»˜ã) ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const keyFromUrl = urlParams.get('key');
            
            // URLã« ?key=AIza... ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ä¿å­˜ã™ã‚‹
            if (keyFromUrl && keyFromUrl.startsWith('AIza')) {
                localStorage.setItem('GEMINI_API_KEY', keyFromUrl);
                // URLã‹ã‚‰ã‚­ãƒ¼ã‚’æ¶ˆã—ã¦ã€ç¶ºéº—ãªURLã«æˆ»ã™
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('APIã‚­ãƒ¼ã‚’è‡ªå‹•è¨­å®šã—ã¾ã—ãŸï¼');
            }

            const savedKey = localStorage.getItem('GEMINI_API_KEY');
            if (savedKey) document.getElementById('settings').style.display = 'none';
            loadData();
         };

        function saveKey() {
            const key = document.getElementById('apiKeyInput').value;
            if (key.startsWith('AIza')) {
                localStorage.setItem('GEMINI_API_KEY', key);
                document.getElementById('settings').style.display = 'none';
                alert('ä¿å­˜å®Œäº†ï¼');
            } else { alert('æ­£ã—ã„ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); }
        }

        async function loadData() {
            const container = document.getElementById('cardContainer');
            container.innerHTML = '<div class="text-center py-10">æœ€æ–°ã®åº§å¸­è¡¨ã‚’å–å¾—ä¸­...</div>';
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                scheduleData = data.schedule;
                renderCards(scheduleData);
            } catch (e) {
                container.innerHTML = '<div class="text-red-500 text-center py-10">èª­ã¿è¾¼ã¿å¤±æ•—ã€‚æ›´æ–°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>';
            }
        }

        function renderCards(list) {
            const container = document.getElementById('cardContainer');
            container.innerHTML = "";
            list.forEach(item => {
                const isDone = doneList.includes(item.student + item.teacher);
                const card = document.createElement('div');
                card.className = `p-4 rounded-2xl shadow-sm border transition active:scale-95 cursor-pointer ${isDone ? 'card-done' : 'card-active'}`;
                card.onclick = () => openReport(item);
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="text-2xl font-black text-slate-800">${item.student} <span class="text-sm font-normal text-slate-500">ã•ã‚“</span></div>
                            <div class="text-sm text-slate-500 font-bold mt-1">${item.teacher} å…ˆç”Ÿ / ${item.koma}</div>
                        </div>
                        ${isDone ? '<span class="bg-emerald-500 text-white text-xs px-2 py-1 rounded-full font-bold">æ¸ˆ</span>' : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function searchStudent() {
            const term = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = scheduleData.filter(i => i.student.toLowerCase().includes(term));
            renderCards(filtered);
        }

        function openReport(item) {
            window.activeReportData = item;
            document.getElementById('viewStudentName').innerText = item.student;
            document.getElementById('viewSubInfo').innerText = `${item.teacher} å…ˆç”Ÿ / ${item.koma}`;
            photoList = [];
            document.getElementById('previewGrid').innerHTML = '';
            document.getElementById('output').value = '';
            document.getElementById('mergedImagePreview').classList.add('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            renderEvaluationRows('è‹±èª');
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('reportView').classList.remove('hidden');
        }

        function backToDashboard() {
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('reportView').classList.add('hidden');
            renderCards(scheduleData);
        }

        function renderEvaluationRows(subject) {
            const container = document.getElementById('evaluationContainer');
            container.innerHTML = '';
            currentEvals = {};
            subjectConfig[subject].forEach(item => {
                currentEvals[item] = 'è‰¯ã„';
                const row = document.createElement('div');
                row.className = 'mb-4 last:mb-0';
                row.innerHTML = `<span class="text-xs font-bold text-slate-500 block mb-2">${item}</span>
                    <div class="flex gap-2">
                        <button class="choice-btn eval-good active" onclick="setEval('${item}', 'è‰¯ã„', this)">è‰¯ã„</button>
                        <button class="choice-btn eval-normal" onclick="setEval('${item}', 'æ™®é€š', this)">æ™®é€š</button>
                        <button class="choice-btn eval-effort" onclick="setEval('${item}', 'è¦åŠªåŠ›', this)">è¦åŠªåŠ›</button>
                    </div>`;
                container.appendChild(row);
            });
        }

        function setEval(item, value, btn) {
            currentEvals[item] = value;
            btn.parentElement.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function changeSubject(subject, btn) {
            selectedSubject = subject;
            document.querySelectorAll('#subjectGroup .choice-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderEvaluationRows(subject);
        }

        function handleFiles(files) {
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = (e) => { photoList.push(e.target.result); renderPreviews(); };
                reader.readAsDataURL(file);
            }
        }

        function renderPreviews() {
            const grid = document.getElementById('previewGrid'); grid.innerHTML = '';
            photoList.forEach((src, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `<img src="${src}"><button class="del-btn" onclick="removePhoto(${index})">âœ•</button>`;
                grid.appendChild(div);
            });
        }
        function removePhoto(index) { photoList.splice(index, 1); renderPreviews(); }

        async function runAI() {
            const apiKey = localStorage.getItem('GEMINI_API_KEY');
            if (!apiKey) { alert("APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„"); return; }
            if (photoList.length === 0) { alert("å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„"); return; }

            const loading = document.getElementById('loading');
            const output = document.getElementById('output');
            const genBtn = document.getElementById('generateBtn');
            
            loading.classList.remove('hidden');
            genBtn.disabled = true;
            output.value = "AIåˆ†æä¸­...";

            try {
                await mergeImages();
                let evalText = Object.entries(currentEvals).map(([k, v]) => `${k}:${v}`).join(', ');
                const prompt = `ã‚ãªãŸã¯å¡¾è¬›å¸«ã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’å…ƒã«ã€ä¿è­·è€…ã¸ã®æˆæ¥­å ±å‘Šæ›¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                    æ•™ç§‘: ${selectedSubject}, è©•ä¾¡: ${evalText}ã€‚
                    ã€åˆ¶ç´„äº‹é …ã€‘
                    1. æŒ¨æ‹¶ã‚„å®šå‹æ–‡ã¯çµ¶å¯¾ã«å«ã‚ãªã„ã€‚
                    2. æœ¬æ–‡ã®ã¿ã‚’250ã€œ300å­—ç¨‹åº¦ã§ä½œæˆã€‚
                    3. ãƒãƒ¼ãƒˆã®å†™çœŸã‚’åˆ†æã—ãŸå…·ä½“çš„ãªæ°—ã¥ãã‚’å«ã‚ã‚‹ã€‚`;

                const imageParts = photoList.map(dataUrl => ({
                    inlineData: { data: dataUrl.split(',')[1], mimeType: "image/jpeg" }
                }));

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...imageParts] }] })
                });

                const data = await response.json();
                output.value = data.candidates[0].content.parts[0].text;
                document.getElementById('saveBtn').classList.remove('hidden');
            } catch (e) {
                output.value = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
            } finally {
                loading.classList.add('hidden');
                genBtn.disabled = false;
            }
        }

        async function mergeImages() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const images = await Promise.all(photoList.map(src => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = src;
                });
            }));
            const targetWidth = 1000;
            let totalHeight = 0;
            const resized = images.map(img => {
                const h = (targetWidth / img.width) * img.height;
                totalHeight += h;
                return { img, h };
            });
            canvas.width = targetWidth;
            canvas.height = totalHeight;
            let currentY = 0;
            resized.forEach(item => { ctx.drawImage(item.img, 0, currentY, targetWidth, item.h); currentY += item.h; });
            const resultImg = document.getElementById('mergedImagePreview');
            resultImg.src = canvas.toDataURL('image/jpeg', 0.8);
            resultImg.classList.remove('hidden');
        }

        async function saveToSheet() {
            const saveBtn = document.getElementById('saveBtn');
            const mergedImg = document.getElementById('mergedImagePreview');
            
            saveBtn.innerText = "å†™çœŸã‚’é€ä¿¡ä¸­... (ç´„5ç§’)";
            saveBtn.disabled = true;

            const payload = {
                student: window.activeReportData.student,
                teacher: window.activeReportData.teacher,
                koma: window.activeReportData.koma,
                subject: selectedSubject,
                aiText: document.getElementById('output').value,
                imageData: mergedImg.src
            };

            try {
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                
                if(result.result === "success") {
                    doneList.push(payload.student + payload.teacher);
                    localStorage.setItem('doneListV3', JSON.stringify(doneList));
                    alert("ä¿å­˜å®Œäº†ï¼ã‚·ãƒ¼ãƒˆã«URLãŒå…¥ã‚Šã¾ã—ãŸã€‚");
                    backToDashboard();
                }
            } catch (e) {
                alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é›»æ³¢ã®è‰¯ã„å ´æ‰€ã§ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
            } finally {
                saveBtn.innerText = "ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¦å®Œäº†";
                saveBtn.disabled = false;
            }
        }

        function copyText() {
            const out = document.getElementById('output');
            out.select();
            navigator.clipboard.writeText(out.value);
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }
    </script>
</body>
</html>
