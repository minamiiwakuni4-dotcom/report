<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>授業報告システム Pro</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px; color: #333;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; color: var(--primary-color); font-size: 1.5rem; }
        
        /* タイルボタンのスタイル */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px; margin-top: 20px;
        }
        .tile {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .tile:active { transform: scale(0.95); background: #eef2f7; }
        .tile.selected { border-color: var(--primary-color); background: #eef2f7; }
        .tile .slot { font-size: 0.8rem; color: #666; margin-top: 5px; }

        /* セクション制御 */
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 入力エリア */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .back-btn { background: #999; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-bottom: 15px; cursor: pointer; }
        textarea { width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-sizing: border-box; font-size: 1rem; }
        button.primary { background: var(--primary-color); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 1.1rem; margin-top: 15px; font-weight: bold; }
        
        #preview-area img { max-width: 100%; border-radius: 10px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .loading { text-align: center; padding: 20px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="main-title">授業報告システム</h1>

    <div id="step-instructor" class="section active">
        <p>あなたの名前を選択してください</p>
        <div id="instructor-grid" class="grid">
            <div class="loading" style="display:block;">読み込み中...</div>
        </div>
    </div>

    <div id="step-student" class="section">
        <button class="back-btn" onclick="showSection('step-instructor')">← 選び直す</button>
        <p><span id="display-instructor"></span>先生の今日の担当生徒</p>
        <div id="student-grid" class="grid"></div>
    </div>

    <div id="step-report" class="section">
        <button class="back-btn" onclick="showSection('step-student')">← 生徒を選び直す</button>
        <div class="card">
            <h3 id="display-student"></h3>
            <p>今日のノートやプリントを撮影してください（最大3枚）</p>
            <input type="file" id="photo-input" accept="image/*" multiple style="margin-bottom: 15px;">
            
            <p>授業のポイントや評価（任意）</p>
            <textarea id="memo" placeholder="例：計算ミスが減りました。集中して取り組めています。"></textarea>
            
            <button class="primary" onclick="analyzeAndGenerate()">AI報告書を作成する</button>
        </div>
    </div>

    <div id="step-result" class="section">
        <div class="card">
            <h3>作成完了！</h3>
            <div id="result-text" style="white-space: pre-wrap; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px;"></div>
            <button class="primary" onclick="copyText()">文章をコピー</button>
            <button style="margin-top:10px; width:100%; padding:10px; background:#eee; border:none; border-radius:5px;" onclick="location.reload()">次の生徒へ</button>
            <div id="preview-area"></div>
        </div>
    </div>

    <div id="loading-spinner" class="loading">
        <p>AIが分析中...（約30秒かかります）</p>
    </div>
</div>

<script>
    // URLからAPIキーを取得
    const urlParams = new URLSearchParams(window.location.search);
    const API_KEY = urlParams.get('key');
    let selectedInstructor = "";
    let selectedStudent = "";

    // 起動時に講師リストを取得
    window.onload = () => {
        if (!API_KEY) {
            alert("APIキーが見つかりません。URLを確認してください。");
            return;
        }
        loadInstructors();
    };

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0, 0);
    }

    // 1. 講師リストの読み込み
    function loadInstructors() {
        google.script.run.withSuccessHandler(data => {
            const grid = document.getElementById('instructor-grid');
            grid.innerHTML = "";
            data.instructors.forEach(name => {
                const div = document.createElement('div');
                div.className = 'tile';
                div.innerText = name;
                div.onclick = () => selectInstructor(name);
                grid.appendChild(div);
            });
        }).getInitialData();
    }

    // 2. 講師選択 -> 生徒リスト表示
    function selectInstructor(name) {
        selectedInstructor = name;
        document.getElementById('display-instructor').innerText = name;
        const grid = document.getElementById('student-grid');
        grid.innerHTML = "読み込み中...";
        showSection('step-student');

        google.script.run.withSuccessHandler(data => {
            grid.innerHTML = "";
            data.students.forEach(s => {
                const div = document.createElement('div');
                div.className = 'tile';
                div.innerHTML = `<div>${s.name}</div><div class="slot">${s.slot}コマ</div>`;
                div.onclick = () => selectStudent(s.name);
                grid.appendChild(div);
            });
        }).getInitialData(name);
    }

    // 3. 生徒選択 -> 報告入力画面
    function selectStudent(name) {
        selectedStudent = name;
        document.getElementById('display-student').innerText = name + " さんの報告";
        showSection('step-report');
    }

    // AI分析と画像処理（ここはこれまでのロジックを統合）
    async function analyzeAndGenerate() {
        const photos = document.getElementById('photo-input').files;
        if (photos.length === 0) {
            alert("写真を撮影してください");
            return;
        }

        const confirmCreate = confirm(`${selectedStudent}さんの報告書を作成します。よろしいですか？`);
        if (!confirmCreate) return;

        document.getElementById('step-report').style.opacity = "0.3";
        document.getElementById('loading-spinner').style.display = "block";

        // 【TODO】ここに以前作成したGemini分析ロジックと画像連結ロジックを組み込みます
        // 今回は構成のみ示し、次のステップで詳細な通信部分を合体させます
        
        // 仮の完了通知
        setTimeout(() => {
            document.getElementById('loading-spinner').style.display = "none";
            document.getElementById('result-text').innerText = `【授業報告：${selectedStudent}さん】\nここにAIが生成した温かい文章が入ります。`;
            showSection('step-result');
        }, 2000);
    }

    function copyText() {
        const text = document.getElementById('result-text').innerText;
        navigator.clipboard.writeText(text).then(() => alert("コピーしました！"));
    }
</script>

</body>
</html>
